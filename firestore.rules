rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection
    match /users/{userId} {
      
      // Allow authenticated users to read any user document
      // (needed for queries to work)
      allow read: if request.auth != null;
      
      // Allow create if authenticated and setting their own authUid
      allow create: if request.auth != null &&
                    request.resource.data.authUid == request.auth.uid;
      
      // Allow update if authenticated and the document's authUid matches their UID
      allow update: if request.auth != null &&
                    resource.data.authUid == request.auth.uid &&
                    request.resource.data.authUid == request.auth.uid;
      
      // Allow delete if authenticated and the document's authUid matches their UID
      allow delete: if request.auth != null &&
                    resource.data.authUid == request.auth.uid;

      // Emergency contacts subcollection
      match /emergency/{contactId} {
        // Helper function to check if user owns the parent document
        // This checks the authUid field in the user document, not the document ID
        function isOwner() {
          return request.auth != null && 
                 get(/databases/$(database)/documents/users/$(userId)).data.authUid == request.auth.uid;
        }
        
        // Allow users to read their own emergency contacts
        allow read: if isOwner();
        
        // Allow users to create emergency contacts under their own profile
        allow create: if isOwner();
        
        // Allow users to update their own emergency contacts
        allow update: if isOwner();
        
        // Allow users to delete their own emergency contacts
        allow delete: if isOwner();
      }
    }
  }
}
